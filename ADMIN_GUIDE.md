# AWSomeShop 管理员指南

## 管理员登录

### 默认管理员账户

系统已创建默认管理员账户：

- **用户名**: `admin`
- **密码**: `password123`
- **邮箱**: `admin@awsomeshop.com`
- **角色**: `admin`

⚠️ **重要**: 在生产环境中，请立即修改默认密码！

### 登录步骤

1. 访问系统首页: `http://localhost:3000`
2. 如果未登录，会自动跳转到登录页面
3. 输入管理员凭据:
   - 用户名: `admin`
   - 密码: `password123`
4. 点击"登录"按钮
5. 登录成功后，导航栏会出现"管理后台"按钮（蓝色盾牌图标）
6. 点击"管理后台"按钮或直接访问 `http://localhost:3000/admin`

## 管理后台功能

管理后台包含三个主要模块：

### 1. 统计报表

显示系统整体运营数据：

- **系统概览**
  - 总用户数、活跃用户数、本月新增用户
  - 积分总量、已兑换积分、剩余积分
  - 产品总数、可用产品、缺货产品
  - 兑换订单统计

- **用户活动统计** (最近30天)
  - 活跃用户数
  - 新增用户数
  - 活跃率和用户增长率
  - 兑换活跃用户 TOP 5

- **兑换统计** (最近30天)
  - 总兑换次数和积分
  - 期间兑换数据
  - 热门产品 TOP 5

### 2. 积分管理

管理用户积分系统：

- **积分概览**
  - 已分配总积分
  - 已兑换积分
  - 用户统计

- **用户列表**
  - 查看所有用户的积分信息
  - 搜索用户（按用户名或邮箱）
  - 查看用户当前余额、累计获得、累计消费
  - 调整用户积分

- **积分调整**
  - 选择用户
  - 输入调整数量（正数为增加，负数为扣除）
  - 填写调整原因
  - 系统会自动记录审计日志

### 3. 产品管理

管理商城产品库存：

- **产品列表**
  - 网格视图展示所有产品
  - 显示产品图片、名称、分类、价格、库存
  - 支持分页浏览

- **创建产品**
  - 点击"创建新产品"按钮
  - 填写产品信息：
    - 产品名称（必填）
    - 产品描述
    - 分类
    - 积分价格（必填）
    - 初始库存（必填）
    - 图片URL
  - 点击"创建产品"完成

- **编辑产品**
  - 点击产品卡片的"编辑"按钮
  - 修改产品信息
  - 点击"更新产品"保存

- **删除产品**
  - 点击产品卡片的"删除"按钮
  - 确认删除操作
  - 注意：删除操作不可撤销

- **库存管理**
  - 使用 +10 / -10 按钮快速调整库存
  - 或通过编辑产品修改精确库存数量

## 管理员权限

管理员拥有以下权限：

- ✅ 查看所有用户的积分信息
- ✅ 调整任意用户的积分（增加或扣除）
- ✅ 批量分配积分（开发中）
- ✅ 创建、编辑、删除产品
- ✅ 管理产品库存
- ✅ 查看系统统计数据
- ✅ 导出数据报表（开发中）
- ✅ 查看审计日志（自动记录）

## 技术说明

### 后端API端点

管理员API都需要admin角色权限：

**积分管理**:
- `GET /api/admin/points/overview` - 积分系统概览
- `GET /api/admin/points/users` - 用户积分列表
- `POST /api/admin/points/bulk-allocate` - 批量分配积分
- `POST /api/admin/points/adjust` - 调整用户积分

**产品管理**:
- `POST /api/admin/products` - 创建产品
- `PUT /api/admin/products/{id}` - 更新产品
- `DELETE /api/admin/products/{id}` - 删除产品
- `PATCH /api/admin/products/{id}/stock` - 更新库存

**统计报表**:
- `GET /api/admin/stats/redemption` - 兑换统计
- `GET /api/admin/stats/user-activity` - 用户活动统计
- `GET /api/admin/stats/system` - 系统综合统计
- `POST /api/admin/stats/export` - 导出数据

### 权限验证

所有管理员API都通过以下中间件进行权限验证：

```python
from app.middleware.admin import get_admin_user

@router.get("/admin/...")
async def admin_endpoint(admin: User = Depends(get_admin_user)):
    # 只有角色为 "admin" 的用户才能访问
    ...
```

### 审计日志

系统会自动记录以下管理员操作：

- 积分调整
- 产品创建、更新、删除
- 库存变更

审计日志包含：
- 操作人员（管理员ID）
- 操作类型
- 资源类型和ID
- 操作详情
- 操作时间

## 密码重置

如果需要重置管理员密码，运行以下命令：

```bash
cd backend
uv run python scripts/reset_admin_password.py
```

这会将管理员密码重置为默认密码 `password123`。

## 创建测试数据

如果需要创建测试用户和数据，运行：

```bash
cd backend
uv run python scripts/init_admin.py
```

这会创建以下测试账户：
- `test_user` / `password123` (1000积分)
- `alice` / `password123` (2000积分)
- `bob` / `password123` (1500积分)

## 故障排除

### 问题1: 无法访问管理后台

**症状**: 访问 `/admin` 时被重定向到首页

**解决方案**:
1. 确认已使用管理员账户登录
2. 检查用户角色是否为 "admin"
3. 清除浏览器缓存和localStorage
4. 重新登录

### 问题2: API返回403错误

**症状**: 管理员操作时返回403 Forbidden错误

**解决方案**:
1. 确认登录用户的role字段为 "admin"
2. 检查JWT token是否有效
3. 查看后端日志确认权限验证逻辑

### 问题3: 登录后看不到"管理后台"按钮

**症状**: 管理员登录后导航栏没有管理后台入口

**解决方案**:
1. 确认数据库中admin用户的role字段为 "admin"（不是 "employee"）
2. 检查前端UserLayout组件的条件渲染逻辑
3. 打开浏览器开发者工具，检查user对象的role属性

## 安全建议

1. **修改默认密码**: 立即修改admin账户的默认密码
2. **限制访问**: 在生产环境中限制管理后台的访问IP
3. **HTTPS**: 生产环境必须使用HTTPS
4. **定期审计**: 定期检查审计日志
5. **权限最小化**: 不要给普通用户admin权限
6. **备份数据**: 定期备份数据库

## 技术支持

如有问题，请查看：
- 后端日志: 检查FastAPI输出
- 前端控制台: 检查浏览器开发者工具
- 数据库: 直接查询确认数据状态
